<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ржорж╛ржжрзНрж░рж╛рж╕рж╛рждрзБрж╕ рж╕рзБржлржлрж╛ ржЖрж▓ ржЗрж╕рж▓рж╛ржорж┐ржпрж╝рж╛ | Madrasa Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&family=Noto+Kufi+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Single File Application: CSS is embedded here -->
    <style>
        :root {
            --primary-color: #0D47A1;
            --secondary-color: #1976D2;
            --accent-color: #FFC107;
            --background-color: #f0f2f5;
            --surface-color: #ffffff;
            --text-color: #212121;
            --text-muted-color: #616161;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --border-color: #e0e0e0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --font-family-en: 'Poppins', sans-serif;
            --font-family-bn: 'Noto Sans Bengali', sans-serif;
            --font-family-ar: 'Noto Kufi Arabic', sans-serif;
        }

        [data-theme="dark"] {
            --primary-color: #1E88E5;
            --secondary-color: #42A5F5;
            --accent-color: #FFCA28;
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --text-color: #e0e0e0;
            --text-muted-color: #9e9e9e;
            --success-color: #66BB6A;
            --error-color: #EF5350;
            --warning-color: #FFA726;
            --border-color: #424242;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html[lang="ar"] body {
            font-family: var(--font-family-ar), var(--font-family-en);
        }
        html[lang="en"] body {
            font-family: var(--font-family-en);
        }
        html[lang="bn"] body {
            font-family: var(--font-family-bn), var(--font-family-en);
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }
        
        body.rtl {
            direction: rtl;
        }

        /* ------------------------- */
        /* LOGIN SCREEN STYLES       */
        /* ------------------------- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
        }

        #login-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .login-subtitle {
            margin-bottom: 2rem;
            color: var(--text-muted-color);
        }

        .input-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        body.rtl .input-group {
            text-align: right;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .input-field, .select-field {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.2);
        }
        
        .btn {
            display: inline-block;
            width: 100%;
            padding: 0.9rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s, transform 0.2s;
            text-decoration: none;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary { background-color: var(--primary-color); color: #ffffff; }
        .btn-primary:hover { background-color: #0b3a82; }
        .btn-secondary { background-color: var(--secondary-color); color: #ffffff; }
        .btn-danger { background-color: var(--error-color); color: #ffffff; }
        .btn-success { background-color: var(--success-color); color: #ffffff; }

        .error-message {
            color: var(--error-color);
            margin-top: 1rem;
            display: none;
        }
        

        /* ------------------------- */
        /* MAIN APP LAYOUT           */
        /* ------------------------- */
        #app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 260px;
            background-color: var(--surface-color);
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transition: width 0.3s ease;
        }
        body.rtl .sidebar {
            border-right: none;
            border-left: 1px solid var(--border-color);
        }

        .sidebar-header { text-align: center; margin-bottom: 2rem; }
        .sidebar-logo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 0.5rem; }
        .sidebar-title { font-size: 1rem; font-weight: 600; }
        .nav-menu { list-style: none; flex-grow: 1; }
        
        .nav-item a {
            display: flex;
            align-items: center;
            padding: 0.9rem 1rem;
            text-decoration: none;
            color: var(--text-muted-color);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .nav-item a:hover { background-color: var(--background-color); color: var(--text-color); }
        .nav-item a.active { background-color: var(--primary-color); color: #ffffff; }
        .nav-icon { margin-right: 1rem; width: 20px; height: 20px; }
        body.rtl .nav-icon { margin-right: 0; margin-left: 1rem; }

        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .app-section { display: none; }
        .app-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .page-header { margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .page-title { font-size: 2rem; font-weight: 700; }

        .card { background-color: var(--surface-color); border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .card-header { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 1.25rem; font-weight: 600; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }

        /* Dashboard specific */
        .stat-card { display: flex; align-items: center; padding: 1.5rem; }
        .stat-card-icon { font-size: 2.5rem; margin-right: 1.5rem; padding: 1rem; border-radius: 50%; color: #fff; }
        body.rtl .stat-card-icon { margin-right: 0; margin-left: 1.5rem; }
        .stat-card-info h3 { font-size: 1rem; color: var(--text-muted-color); font-weight: 500; }
        .stat-card-info p { font-size: 1.75rem; font-weight: 700; }

        .icon-income { background-color: var(--success-color); }
        .icon-expense { background-color: var(--error-color); }
        .icon-cash { background-color: var(--warning-color); }
        .icon-balance { background-color: var(--primary-color); }
        .icon-students { background-color: var(--accent-color); }
        
        /* Table Styles */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        body.rtl table { text-align: right; }
        th, td { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        thead { background-color: var(--background-color); }
        th { font-weight: 600; font-size: 0.9rem; text-transform: uppercase; color: var(--text-muted-color); }
        tbody tr:hover { background-color: var(--background-color); }
        .action-buttons button { margin: 0 0.25rem; padding: 0.4rem 0.6rem; font-size: 0.9rem; border: none; border-radius: 5px; cursor: pointer; }
        .student-image-sm { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        
        /* Form & Modal Styles */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .form-grid .full-width { grid-column: 1 / -1; }
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--surface-color); margin: auto; padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 600px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 600; }
        .close-button { color: var(--text-muted-color); font-size: 2rem; font-weight: bold; cursor: pointer; }

        /* Student Search Result Style */
        .student-search-card { display: flex; align-items: center; gap: 1.5rem; }
        .student-image-lg { width: 100px; height: 100px; border-radius: var(--border-radius); object-fit: cover; border: 3px solid var(--border-color); }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .mt-1 { margin-top: 1rem; } .mt-2 { margin-top: 2rem; }
        .mb-1 { margin-bottom: 1rem; } .mb-2 { margin-bottom: 2rem; }
        .d-flex { display: flex; } .justify-between { justify-content: space-between; } .align-center { align-items: center; }
        .w-100 { width: 100%; }
        
    </style>
</head>
<body>

    <!-- 
    ======================================
    LOGIN SCREEN
    ======================================
    -->
    <div id="login-screen">
        <div class="login-container">
            <img src="https://i.ibb.co/5gYT2Z99/476160855-122102446826755617-3674873459737657297-n.jpg" alt="Madrasa Logo" class="login-logo">
            <h1 class="login-title">ржорж╛ржжрзНрж░рж╛рж╕рж╛рждрзБрж╕ рж╕рзБржлржлрж╛ ржЖрж▓ ржЗрж╕рж▓рж╛ржорж┐ржпрж╝рж╛</h1>
            <p class="login-subtitle">Management Application</p>
            <form id="login-form">
                <div class="input-group">
                    <label for="password" data-translate-key="passwordLabel">ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржжрж┐ржи</label>
                    <input type="password" id="password" class="input-field" required>
                </div>
                <button type="submit" class="btn btn-primary" data-translate-key="loginButton">ржкрзНрж░ржмрзЗрж╢ ржХрж░рзБржи</button>
                <p id="login-error" class="error-message" data-translate-key="loginError">ржнрзБрж▓ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб!</p>
            </form>
        </div>
    </div>

    <!-- 
    ======================================
    MAIN APPLICATION CONTAINER
    ======================================
    -->
    <div id="app-container" style="visibility: hidden;">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="https://i.ibb.co/5gYT2Z99/476160855-122102446826755617-3674873459737657297-n.jpg" alt="Madrasa Logo" class="sidebar-logo">
                <h2 class="sidebar-title">ржорж╛ржжрзНрж░рж╛рж╕рж╛рждрзБрж╕ рж╕рзБржлржлрж╛</h2>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="#dashboard" class="nav-link active"><span class="nav-icon">ЁЯУК</span> <span data-translate-key="navDashboard">ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</span></a></li>
                <li class="nav-item"><a href="#students" class="nav-link"><span class="nav-icon">ЁЯСитАНЁЯОУ</span> <span data-translate-key="navStudents">ржЫрж╛рждрзНрж░ ржкрж░рж┐ржЪрж╛рж▓ржирж╛</span></a></li>
                <li class="nav-item"><a href="#fees" class="nav-link"><span class="nav-icon">ЁЯТ░</span> <span data-translate-key="navFees">ржорж╛рж╕рж┐ржХ ржлрж┐</span></a></li>
                <li class="nav-item"><a href="#expenses" class="nav-link"><span class="nav-icon">ЁЯПа</span> <span data-translate-key="navExpenses">рж▓рж┐рж▓рзНрж▓рж╛рж╣ ржмрзЛрж░рзНржбрж┐ржВ ржЦрж░ржЪ</span></a></li>
                <li class="nav-item"><a href="#donations" class="nav-link"><span class="nav-icon">ЁЯд▓</span> <span data-translate-key="navDonations">ржжрж╛ржи / рж╕рж╛ржжржХрж╛</span></a></li>
                <li class="nav-item"><a href="#settings" class="nav-link"><span class="nav-icon">тЪЩя╕П</span> <span data-translate-key="navSettings">рж╕рзЗржЯрж┐ржВрж╕</span></a></li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- DASHBOARD -->
            <section id="dashboard" class="app-section active">
                <div class="page-header">
                    <h1 class="page-title" data-translate-key="dashboardTitle">ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</h1>
                </div>
                <div class="grid-container">
                    <div class="card stat-card">
                        <div class="stat-card-icon icon-income">ЁЯТ░</div>
                        <div class="stat-card-info">
                            <h3 data-translate-key="totalIncome">рж╕рж░рзНржмржорзЛржЯ ржЖржпрж╝</h3>
                            <p id="total-income">рз│рзж</p>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-card-icon icon-expense">ЁЯТ╕</div>
                        <div class="stat-card-info">
                            <h3 data-translate-key="totalExpense">рж╕рж░рзНржмржорзЛржЯ ржмрзНржпржпрж╝</h3>
                            <p id="total-expense">рз│рзж</p>
                        </div>
                    </div>
                     <!-- NEW: Cash Balance Card -->
                    <div class="card stat-card">
                        <div class="stat-card-icon icon-cash">ЁЯПж</div>
                        <div class="stat-card-info">
                            <h3 data-translate-key="cashBalance">ржмрж░рзНрждржорж╛ржирзЗ ржХрзНржпрж╛рж╢рзЗ ржЖржЫрзЗ</h3>
                            <p id="cash-balance">рз│рзж</p>
                        </div>
                    </div>
                    <div class="card stat-card">
                         <div class="stat-card-icon icon-balance">ЁЯЧУя╕П</div>
                        <div class="stat-card-info">
                            <h3 data-translate-key="monthlyIncome">ржЪрж▓рждрж┐ ржорж╛рж╕рзЗрж░ ржЖржпрж╝</h3>
                            <p id="monthly-income">рз│рзж</p>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-card-icon icon-balance">ЁЯУЕ</div>
                        <div class="stat-card-info">
                            <h3 data-translate-key="yearlyIncome">ржЪрж▓рждрж┐ ржмржЫрж░рзЗрж░ ржЖржпрж╝</h3>
                            <p id="yearly-income">рз│рзж</p>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-card-icon icon-students">ЁЯСитАНЁЯОУ</div>
                        <div class="stat-card-info">
                            <h3 data-translate-key="totalStudents">ржорзЛржЯ ржЫрж╛рждрзНрж░</h3>
                            <p id="total-students">рзж</p>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-card-icon icon-students">ЁЯПа</div>
                        <div class="stat-card-info">
                            <h3 data-translate-key="lillahStudents">рж▓рж┐рж▓рзНрж▓рж╛рж╣ ржмрзЛрж░рзНржбрж┐ржВ ржЫрж╛рждрзНрж░</h3>
                            <p id="lillah-students">рзж</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- STUDENTS -->
            <section id="students" class="app-section">
                <div class="page-header d-flex justify-between align-center">
                    <h1 class="page-title" data-translate-key="studentsTitle">ржЫрж╛рждрзНрж░ ржкрж░рж┐ржЪрж╛рж▓ржирж╛</h1>
                    <button class="btn btn-primary" id="add-student-btn" data-translate-key="addStudentBtn">ржирждрзБржи ржЫрж╛рждрзНрж░ ржпрзЛржЧ ржХрж░рзБржи</button>
                </div>
                 <div class="card">
                     <div class="card-header">
                        <h3 class="card-title" data-translate-key="searchStudent">ржЫрж╛рждрзНрж░ ржЦрзБржБржЬрзБржи</h3>
                    </div>
                     <div class="input-group">
                        <label for="search-student-serial" data-translate-key="searchBySerial">рж╕рж┐рж░рж┐ржпрж╝рж╛рж▓ ржиржорзНржмрж░ ржжрзНржмрж╛рж░рж╛ ржЫрж╛рждрзНрж░ ржЦрзБржБржЬрзБржи</label>
                        <input type="number" id="search-student-serial" class="input-field" data-translate-key-placeholder="enterSerialPlaceholder">
                    </div>
                    <div id="student-search-result"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" data-translate-key="allStudents">рж╕ржХрж▓ ржЫрж╛рждрзНрж░</h3>
                    </div>
                    <div class="table-container">
                        <table id="students-table">
                            <thead>
                                <tr>
                                    <th data-translate-key="thSerial">рж╕рж┐рж░рж┐ржпрж╝рж╛рж▓</th>
                                    <th data-translate-key="thImage">ржЫржмрж┐</th>
                                    <th data-translate-key="thName">ржирж╛ржо</th>
                                    <th data-translate-key="thFatherName">ржкрж┐рждрж╛рж░ ржирж╛ржо</th>
                                    <th data-translate-key="thDepartment">ржмрж┐ржнрж╛ржЧ</th>
                                    <th data-translate-key="thRoll">рж░рзЛрж▓</th>
                                    <th data-translate-key="thResidence">ржЖржмрж╛рж╕ржи</th>
                                    <th data-translate-key="thActions">ржкржжржХрзНрж╖рзЗржк</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- FEES -->
            <section id="fees" class="app-section">
                 <div class="page-header">
                    <h1 class="page-title" data-translate-key="feesTitle">ржЫрж╛рждрзНрж░рзЗрж░ ржорж╛рж╕рж┐ржХ ржлрж┐</h1>
                </div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title" data-translate-key="feeCollection">ржлрж┐ ржХрж╛рж▓рзЗржХрж╢ржи</h3></div>
                    <div class="input-group">
                        <label for="fee-student-search" data-translate-key="searchBySerial">рж╕рж┐рж░рж┐ржпрж╝рж╛рж▓ ржиржорзНржмрж░ ржжрзНржмрж╛рж░рж╛ ржЫрж╛рждрзНрж░ ржЦрзБржБржЬрзБржи</label>
                        <input type="number" id="fee-student-search" class="input-field" data-translate-key-placeholder="enterSerialPlaceholder">
                    </div>
                    <div id="fee-student-info" style="display:none;">
                        <h4 id="fee-student-name"></h4>
                        <p><span data-translate-key="fatherNameLabel">ржкрж┐рждрж╛рж░ ржирж╛ржо</span>: <span id="fee-father-name"></span></p>
                        <p><span data-translate-key="monthlyFeeLabel">ржорж╛рж╕рж┐ржХ ржлрж┐</span>: <span id="fee-monthly-amount"></span></p>
                        <!-- DUE SYSTEM REMOVED -->
                        <hr class="mt-1 mb-2">
                        <div class="form-grid">
                             <div class="input-group">
                                <label for="fee-month" data-translate-key="selectMonth">ржорж╛рж╕ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</label>
                                <input type="month" id="fee-month" class="input-field">
                            </div>
                            <div class="input-group">
                                <label for="fee-paid-amount" data-translate-key="paidAmount">ржкрзНрж░ржжрждрзНржд ржкрж░рж┐ржорж╛ржг</label>
                                <input type="number" id="fee-paid-amount" class="input-field" data-translate-key-placeholder="amountPlaceholder">
                            </div>
                        </div>
                        <button id="save-fee-payment" class="btn btn-success mt-1" data-translate-key="savePaymentBtn">ржкрзЗржорзЗржирзНржЯ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи</button>
                    </div>
                    <div id="fee-payment-history" class="mt-2"></div>
                </div>
            </section>

            <!-- EXPENSES -->
            <section id="expenses" class="app-section">
                <div class="page-header">
                    <h1 class="page-title" data-translate-key="expensesTitle">рж▓рж┐рж▓рзНрж▓рж╛рж╣ ржмрзЛрж░рзНржбрж┐ржВ ржЦрж░ржЪ</h1>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" data-translate-key="addExpense">ржирждрзБржи ржЦрж░ржЪ ржпрзЛржЧ ржХрж░рзБржи</h3>
                    </div>
                    <form id="expense-form" class="form-grid">
                        <div class="input-group">
                             <label for="expense-date" data-translate-key="date">рждрж╛рж░рж┐ржЦ</label>
                             <input type="date" id="expense-date" class="input-field" required>
                        </div>
                        <div class="input-group">
                            <label for="expense-amount" data-translate-key="expenseAmount">ржЦрж░ржЪрзЗрж░ ржкрж░рж┐ржорж╛ржг</label>
                            <input type="number" id="expense-amount" class="input-field" data-translate-key-placeholder="amountPlaceholder" required>
                        </div>
                        <div class="input-group full-width">
                             <label for="expense-description" data-translate-key="description">ржмрж┐ржмрж░ржг</label>
                             <input type="text" id="expense-description" class="input-field" data-translate-key-placeholder="descriptionPlaceholder" required>
                        </div>
                        <div class="full-width">
                            <button type="submit" class="btn btn-primary" data-translate-key="saveExpenseBtn">ржЦрж░ржЪ рж╕ржВрж░ржХрзНрж╖ржг</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" data-translate-key="expenseRecords">ржЦрж░ржЪрзЗрж░ рж╣рж┐рж╕рж╛ржм</h3>
                    </div>
                    <div class="table-container">
                         <table id="expenses-table">
                            <thead>
                                <tr>
                                    <th data-translate-key="thDate">рждрж╛рж░рж┐ржЦ</th>
                                    <th data-translate-key="thDescription">ржмрж┐ржмрж░ржг</th>
                                    <th data-translate-key="thAmount">ржкрж░рж┐ржорж╛ржг (ржЯрж╛ржХрж╛)</th>
                                    <th data-translate-key="thActions">ржкржжржХрзНрж╖рзЗржк</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- DONATIONS -->
            <section id="donations" class="app-section">
                 <div class="page-header d-flex justify-between align-center">
                    <h1 class="page-title" data-translate-key="donationsTitle">ржжрж╛ржи / рж╕рж╛ржжржХрж╛</h1>
                    <button id="add-donation-btn" class="btn btn-primary" data-translate-key="addDonationBtn">ржирждрзБржи ржжрж╛ржи ржпрзЛржЧ ржХрж░рзБржи</button>
                </div>
                 <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" data-translate-key="allDonations">рж╕ржХрж▓ ржжрж╛ржи</h3>
                    </div>
                    <div class="table-container">
                        <table id="donations-table">
                            <thead>
                                <tr>
                                    <th data-translate-key="thDate">рждрж╛рж░рж┐ржЦ</th>
                                    <th data-translate-key="thDonorName">ржжрж╛рждрж╛рж░ ржирж╛ржо</th>
                                    <th data-translate-key="thAmount">ржкрж░рж┐ржорж╛ржг</th>
                                    <th data-translate-key="thDonationType">ржжрж╛ржирзЗрж░ ржкрзНрж░ржХрж╛рж░</th>
                                    <th data-translate-key="thReceiptNo">рж░рж╕рж┐ржж ржиржорзНржмрж░</th>
                                    <th data-translate-key="thActions">ржкржжржХрзНрж╖рзЗржк</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- SETTINGS -->
            <section id="settings" class="app-section">
                <div class="page-header">
                    <h1 class="page-title" data-translate-key="settingsTitle">рж╕рзЗржЯрж┐ржВрж╕</h1>
                </div>
                 <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" data-translate-key="changePassword">ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи</h3>
                    </div>
                    <form id="change-password-form">
                        <div class="input-group">
                            <label for="current-password" data-translate-key="currentPassword">ржмрж░рзНрждржорж╛ржи ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб</label>
                            <input type="password" id="current-password" class="input-field" required>
                        </div>
                        <div class="input-group">
                            <label for="new-password" data-translate-key="newPassword">ржирждрзБржи ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб</label>
                            <input type="password" id="new-password" class="input-field" required>
                        </div>
                        <button type="submit" class="btn btn-primary" data-translate-key="changePasswordBtn">ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзБржи</button>
                        <p id="password-change-status" class="mt-1"></p>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" data-translate-key="theme">ржерж┐ржо</h3>
                    </div>
                    <div class="input-group">
                        <label for="theme-selector" data-translate-key="selectTheme">ржЕрзНржпрж╛ржк ржерж┐ржо ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</label>
                        <select id="theme-selector" class="select-field">
                            <option value="light" data-translate-key="lightMode">рж▓рж╛ржЗржЯ ржорзЛржб</option>
                            <option value="dark" data-translate-key="darkMode">ржбрж╛рж░рзНржХ ржорзЛржб</option>
                        </select>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" data-translate-key="language">ржнрж╛рж╖рж╛</h3>
                    </div>
                    <div class="input-group">
                        <label for="language-selector" data-translate-key="selectLanguage">ржЕрзНржпрж╛ржк ржнрж╛рж╖рж╛ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи</label>
                         <select id="language-selector" class="select-field">
                            <option value="bn">Bengali (ржмрж╛ржВрж▓рж╛)</option>
                            <option value="en">English</option>
                            <option value="ar">Arabic (╪з┘Д╪╣╪▒╪и┘К╪й)</option>
                        </select>
                    </div>
                    <p class="text-muted-color mt-1" data-translate-key="settingsInfoText">
                        "You can change everything by going to the app's settings, such as running in dark mode or light mode, and changing the app's language, such as English, Bengali, and Arabic."
                    </p>
                </div>
            </section>
        </main>
    </div>

    <!-- MODALS -->
    <!-- Student Add/Edit Modal -->
    <div id="student-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="student-modal-title" class="modal-title"></h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="student-form">
                <input type="hidden" id="student-id">
                <div class="form-grid">
                    <div class="input-group"><label for="student-name" data-translate-key="studentNameLabel">ржЫрж╛рждрзНрж░рзЗрж░ ржирж╛ржо</label><input type="text" id="student-name" class="input-field" required></div>
                    <div class="input-group"><label for="student-image-url" data-translate-key="imageUrlLabel">ржЫржмрж┐рж░ URL</label><input type="text" id="student-image-url" class="input-field"></div>
                    <div class="input-group"><label for="father-name" data-translate-key="fatherNameLabel">ржкрж┐рждрж╛рж░ ржирж╛ржо</label><input type="text" id="father-name" class="input-field" required></div>
                    <div class="input-group"><label for="mother-name" data-translate-key="motherNameLabel">ржорж╛рждрж╛рж░ ржирж╛ржо</label><input type="text" id="mother-name" class="input-field" required></div>
                    <div class="input-group full-width"><label for="address" data-translate-key="addressLabel">ржарж┐ржХрж╛ржирж╛</label><input type="text" id="address" class="input-field" required></div>
                    <div class="input-group"><label for="department" data-translate-key="departmentLabel">ржмрж┐ржнрж╛ржЧ</label><input type="text" id="department" class="input-field" required></div>
                    <div class="input-group"><label for="roll" data-translate-key="rollLabel">рж░рзЛрж▓ ржиржорзНржмрж░</label><input type="number" id="roll" class="input-field" required></div>
                    <div class="input-group"><label for="monthly-fee" data-translate-key="monthlyFeeLabel">ржорж╛рж╕рж┐ржХ ржлрж┐</label><input type="number" id="monthly-fee" class="input-field" required></div>
                    <div class="input-group">
                        <label for="residence-type" data-translate-key="residenceTypeLabel">ржЖржмрж╛рж╕ржи ржкрзНрж░ржХрж╛рж░</label>
                        <select id="residence-type" class="select-field">
                            <option value="Residential" data-translate-key="residenceResidential">ржЖржмрж╛рж╕рж┐ржХ</option>
                            <option value="Non-Residential" data-translate-key="residenceNonResidential">ржЕржирж╛ржмрж╛рж╕рж┐ржХ</option>
                            <option value="Day Care" data-translate-key="residenceDayCare">ржбрзЗ ржХрзЗржпрж╝рж╛рж░</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="lillah-boarding" data-translate-key="lillahBoardingLabel">рж▓рж┐рж▓рзНрж▓рж╛рж╣ ржмрзЛрж░рзНржбрж┐ржВ</label>
                        <select id="lillah-boarding" class="select-field">
                            <option value="No" data-translate-key="no">ржирж╛</option>
                            <option value="Yes" data-translate-key="yes">рж╣рзНржпрж╛ржБ</option>
                        </select>
                    </div>
                </div>
                <div class="mt-2"><button type="submit" class="btn btn-primary w-100" data-translate-key="saveBtn">рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи</button></div>
            </form>
        </div>
    </div>
    
    <!-- Donation Add/Edit Modal -->
    <div id="donation-modal" class="modal">
        <div class="modal-content">
             <div class="modal-header">
                <h2 id="donation-modal-title" class="modal-title"></h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="donation-form">
                <input type="hidden" id="donation-id">
                 <div class="form-grid">
                    <div class="input-group"><label for="donor-name" data-translate-key="donorNameLabel">ржжрж╛рждрж╛рж░ ржирж╛ржо</label><input type="text" id="donor-name" class="input-field" required></div>
                    <div class="input-group"><label for="donation-amount" data-translate-key="donationAmountLabel">ржжрж╛ржирзЗрж░ ржкрж░рж┐ржорж╛ржг</label><input type="number" id="donation-amount" class="input-field" required></div>
                    <div class="input-group"><label for="donation-type" data-translate-key="donationTypeLabel">ржжрж╛ржирзЗрж░ ржкрзНрж░ржХрж╛рж░</label><input type="text" id="donation-type" class="input-field" data-translate-key-placeholder="donationTypePlaceholder" required></div>
                    <div class="input-group"><label for="receiver-book" data-translate-key="receiverBookLabel">ржЧрзНрж░рж╣рзАрждрж╛ ржмржЗрзЯрзЗрж░ ржирж╛ржо</label><input type="text" id="receiver-book" class="input-field"></div>
                    <div class="input-group"><label for="receipt-number" data-translate-key="receiptNoLabel">рж░рж╕рж┐ржж ржиржорзНржмрж░</label><input type="text" id="receipt-number" class="input-field"></div>
                 </div>
                 <div class="mt-2"><button type="submit" class="btn btn-primary w-100" data-translate-key="saveBtn">рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи</button></div>
            </form>
        </div>
    </div>

    <!-- 
    ======================================
    JAVASCRIPT LOGIC
    ======================================
    -->
    <script>
    window.onload = function() {
        'use strict';

        // ===================================
        // TRANSLATION DICTIONARY
        // ===================================
        const translations = {
            bn: {
                passwordLabel: 'ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржжрж┐ржи', loginButton: 'ржкрзНрж░ржмрзЗрж╢ ржХрж░рзБржи', loginError: 'ржнрзБрж▓ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб!',
                navDashboard: 'ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб', navStudents: 'ржЫрж╛рждрзНрж░ ржкрж░рж┐ржЪрж╛рж▓ржирж╛', navFees: 'ржорж╛рж╕рж┐ржХ ржлрж┐', navExpenses: 'рж▓рж┐рж▓рзНрж▓рж╛рж╣ ржмрзЛрж░рзНржбрж┐ржВ ржЦрж░ржЪ', navDonations: 'ржжрж╛ржи / рж╕рж╛ржжржХрж╛', navSettings: 'рж╕рзЗржЯрж┐ржВрж╕',
                dashboardTitle: 'ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб', totalIncome: 'рж╕рж░рзНржмржорзЛржЯ ржЖржпрж╝', totalExpense: 'рж╕рж░рзНржмржорзЛржЯ ржмрзНржпржпрж╝', cashBalance: 'ржмрж░рзНрждржорж╛ржирзЗ ржХрзНржпрж╛рж╢рзЗ ржЖржЫрзЗ', monthlyIncome: 'ржЪрж▓рждрж┐ ржорж╛рж╕рзЗрж░ ржЖржпрж╝', yearlyIncome: 'ржЪрж▓рждрж┐ ржмржЫрж░рзЗрж░ ржЖржпрж╝', totalStudents: 'ржорзЛржЯ ржЫрж╛рждрзНрж░', lillahStudents: 'рж▓рж┐рж▓рзНрж▓рж╛рж╣ ржмрзЛрж░рзНржбрж┐ржВ ржЫрж╛рждрзНрж░',
                studentsTitle: 'ржЫрж╛рждрзНрж░ ржкрж░рж┐ржЪрж╛рж▓ржирж╛', addStudentBtn: 'ржирждрзБржи ржЫрж╛рждрзНрж░ ржпрзЛржЧ ржХрж░рзБржи', searchStudent: 'ржЫрж╛рждрзНрж░ ржЦрзБржБржЬрзБржи', searchBySerial: 'рж╕рж┐рж░рж┐ржпрж╝рж╛рж▓ ржиржорзНржмрж░ ржжрзНржмрж╛рж░рж╛ ржЫрж╛рждрзНрж░ ржЦрзБржБржЬрзБржи', enterSerialPlaceholder: 'рж╕рж┐рж░рж┐ржпрж╝рж╛рж▓ ржиржорзНржмрж░ рж▓рж┐ржЦрзБржи...',
                allStudents: 'рж╕ржХрж▓ ржЫрж╛рждрзНрж░', thSerial: 'рж╕рж┐рж░рж┐ржпрж╝рж╛рж▓', thImage: 'ржЫржмрж┐', thName: 'ржирж╛ржо', thFatherName: 'ржкрж┐рждрж╛рж░ ржирж╛ржо', thDepartment: 'ржмрж┐ржнрж╛ржЧ', thRoll: 'рж░рзЛрж▓', thResidence: 'ржЖржмрж╛рж╕ржи', thActions: 'ржкржжржХрзНрж╖рзЗржк', editBtn: 'рж╕ржорзНржкрж╛ржжржирж╛', deleteBtn: 'ржорзБржЫрзБржи',
                noStudentFound: 'ржХрзЛржирзЛ ржЫрж╛рждрзНрж░ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред', studentNotFoundWithSerial: 'ржПржЗ рж╕рж┐рж░рж┐ржпрж╝рж╛рж▓рзЗ ржХрзЛржирзЛ ржЫрж╛рждрзНрж░ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред',
                feesTitle: 'ржЫрж╛рждрзНрж░рзЗрж░ ржорж╛рж╕рж┐ржХ ржлрж┐', feeCollection: 'ржлрж┐ ржХрж╛рж▓рзЗржХрж╢ржи', selectMonth: 'ржорж╛рж╕ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи', paidAmount: 'ржкрзНрж░ржжрждрзНржд ржкрж░рж┐ржорж╛ржг', amountPlaceholder: 'ржЯрж╛ржХрж╛рж░ ржкрж░рж┐ржорж╛ржг', savePaymentBtn: 'ржкрзЗржорзЗржирзНржЯ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи', paymentHistory: 'ржкрзЗржорзЗржирзНржЯ ржЗрждрж┐рж╣рж╛рж╕', noPaymentFound: 'ржХрзЛржирзЛ ржкрзЗржорзЗржирзНржЯ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред',
                expensesTitle: 'рж▓рж┐рж▓рзНрж▓рж╛рж╣ ржмрзЛрж░рзНржбрж┐ржВ ржЦрж░ржЪ', addExpense: 'ржирждрзБржи ржЦрж░ржЪ ржпрзЛржЧ ржХрж░рзБржи', date: 'рждрж╛рж░рж┐ржЦ', expenseAmount: 'ржЦрж░ржЪрзЗрж░ ржкрж░рж┐ржорж╛ржг', description: 'ржмрж┐ржмрж░ржг', descriptionPlaceholder: 'ржЦрж░ржЪрзЗрж░ ржмрж┐ржмрж░ржг', saveExpenseBtn: 'ржЦрж░ржЪ рж╕ржВрж░ржХрзНрж╖ржг', expenseRecords: 'ржЦрж░ржЪрзЗрж░ рж╣рж┐рж╕рж╛ржм', noExpenseFound: 'ржХрзЛржирзЛ ржЦрж░ржЪ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред',
                donationsTitle: 'ржжрж╛ржи / рж╕рж╛ржжржХрж╛', addDonationBtn: 'ржирждрзБржи ржжрж╛ржи ржпрзЛржЧ ржХрж░рзБржи', allDonations: 'рж╕ржХрж▓ ржжрж╛ржи', thDonorName: 'ржжрж╛рждрж╛рж░ ржирж╛ржо', thAmount: 'ржкрж░рж┐ржорж╛ржг', thDonationType: 'ржжрж╛ржирзЗрж░ ржкрзНрж░ржХрж╛рж░', thReceiptNo: 'рж░рж╕рж┐ржж ржиржорзНржмрж░', thDate: 'рждрж╛рж░рж┐ржЦ', noDonationFound: 'ржХрзЛржирзЛ ржжрж╛ржи ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред',
                settingsTitle: 'рж╕рзЗржЯрж┐ржВрж╕', changePassword: 'ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи', currentPassword: 'ржмрж░рзНрждржорж╛ржи ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб', newPassword: 'ржирждрзБржи ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб', changePasswordBtn: 'ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзБржи', passwordSuccess: 'ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб рж╕ржлрж▓ржнрж╛ржмрзЗ ржкрж░рж┐ржмрж░рзНрждржи рж╣ржпрж╝рзЗржЫрзЗ!', passwordError: 'ржмрж░рзНрждржорж╛ржи ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржнрзБрж▓!',
                theme: 'ржерж┐ржо', selectTheme: 'ржЕрзНржпрж╛ржк ржерж┐ржо ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи', lightMode: 'рж▓рж╛ржЗржЯ ржорзЛржб', darkMode: 'ржбрж╛рж░рзНржХ ржорзЛржб',
                language: 'ржнрж╛рж╖рж╛', selectLanguage: 'ржЕрзНржпрж╛ржк ржнрж╛рж╖рж╛ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи', settingsInfoText: 'You can change everything by going to the app\'s settings, such as running in dark mode or light mode, and changing the app\'s language, such as English, Bengali, and Arabic.',
                // Modal specific
                addNewStudentTitle: 'ржирждрзБржи ржЫрж╛рждрзНрж░ ржпрзЛржЧ ржХрж░рзБржи', updateStudentTitle: 'ржЫрж╛рждрзНрж░рзЗрж░ рждржерзНржп ржЖржкржбрзЗржЯ ржХрж░рзБржи', studentNameLabel: 'ржЫрж╛рждрзНрж░рзЗрж░ ржирж╛ржо', imageUrlLabel: 'ржЫржмрж┐рж░ URL', fatherNameLabel: 'ржкрж┐рждрж╛рж░ ржирж╛ржо', motherNameLabel: 'ржорж╛рждрж╛рж░ ржирж╛ржо', addressLabel: 'ржарж┐ржХрж╛ржирж╛', departmentLabel: 'ржмрж┐ржнрж╛ржЧ', rollLabel: 'рж░рзЛрж▓ ржиржорзНржмрж░', monthlyFeeLabel: 'ржорж╛рж╕рж┐ржХ ржлрж┐', residenceTypeLabel: 'ржЖржмрж╛рж╕ржи ржкрзНрж░ржХрж╛рж░', residenceResidential: 'ржЖржмрж╛рж╕рж┐ржХ', residenceNonResidential: 'ржЕржирж╛ржмрж╛рж╕рж┐ржХ', residenceDayCare: 'ржбрзЗ ржХрзЗржпрж╝рж╛рж░', lillahBoardingLabel: 'рж▓рж┐рж▓рзНрж▓рж╛рж╣ ржмрзЛрж░рзНржбрж┐ржВ', no: 'ржирж╛', yes: 'рж╣рзНржпрж╛ржБ', saveBtn: 'рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи',
                addNewDonationTitle: 'ржирждрзБржи ржжрж╛ржи ржпрзЛржЧ ржХрж░рзБржи', updateDonationTitle: 'ржжрж╛ржирзЗрж░ рждржерзНржп ржЖржкржбрзЗржЯ ржХрж░рзБржи', donorNameLabel: 'ржжрж╛рждрж╛рж░ ржирж╛ржо', donationAmountLabel: 'ржжрж╛ржирзЗрж░ ржкрж░рж┐ржорж╛ржг', donationTypeLabel: 'ржжрж╛ржирзЗрж░ ржкрзНрж░ржХрж╛рж░', donationTypePlaceholder: 'ржпрзЗржоржи: рж╕рж╛ржзрж╛рж░ржг, ржпрж╛ржХрж╛ржд', receiverBookLabel: 'ржЧрзНрж░рж╣рзАрждрж╛ ржмржЗрзЯрзЗрж░ ржирж╛ржо', receiptNoLabel: 'рж░рж╕рж┐ржж ржиржорзНржмрж░',
            },
            en: {
                passwordLabel: 'Enter Password', loginButton: 'Login', loginError: 'Wrong Password!',
                navDashboard: 'Dashboard', navStudents: 'Student Management', navFees: 'Monthly Fee', navExpenses: 'Lillah Boarding Expense', navDonations: 'Donation / Sadqa', navSettings: 'Settings',
                dashboardTitle: 'Dashboard', totalIncome: 'Total Income', totalExpense: 'Total Expense', cashBalance: 'Current Cash Balance', monthlyIncome: 'This Month\'s Income', yearlyIncome: 'This Year\'s Income', totalStudents: 'Total Students', lillahStudents: 'Lillah Boarding Students',
                studentsTitle: 'Student Management', addStudentBtn: 'Add New Student', searchStudent: 'Search Student', searchBySerial: 'Search Student by Serial Number', enterSerialPlaceholder: 'Enter serial number...',
                allStudents: 'All Students', thSerial: 'Serial', thImage: 'Image', thName: 'Name', thFatherName: 'Father\'s Name', thDepartment: 'Department', thRoll: 'Roll', thResidence: 'Residence', thActions: 'Actions', editBtn: 'Edit', deleteBtn: 'Delete',
                noStudentFound: 'No students found.', studentNotFoundWithSerial: 'No student found with this serial number.',
                feesTitle: 'Student Monthly Fee', feeCollection: 'Fee Collection', selectMonth: 'Select Month', paidAmount: 'Paid Amount', amountPlaceholder: 'Enter amount', savePaymentBtn: 'Save Payment', paymentHistory: 'Payment History', noPaymentFound: 'No payments found.',
                expensesTitle: 'Lillah Boarding Expense', addExpense: 'Add New Expense', date: 'Date', expenseAmount: 'Expense Amount', description: 'Description', descriptionPlaceholder: 'Expense description', saveExpenseBtn: 'Save Expense', expenseRecords: 'Expense Records', noExpenseFound: 'No expenses found.',
                donationsTitle: 'Donation / Sadqa', addDonationBtn: 'Add New Donation', allDonations: 'All Donations', thDonorName: 'Donor Name', thAmount: 'Amount', thDonationType: 'Donation Type', thReceiptNo: 'Receipt No.', thDate: 'Date', noDonationFound: 'No donations found.',
                settingsTitle: 'Settings', changePassword: 'Change Password', currentPassword: 'Current Password', newPassword: 'New Password', changePasswordBtn: 'Change Password', passwordSuccess: 'Password changed successfully!', passwordError: 'Incorrect current password!',
                theme: 'Theme', selectTheme: 'Select App Theme', lightMode: 'Light Mode', darkMode: 'Dark Mode',
                language: 'Language', selectLanguage: 'Select App Language', settingsInfoText: 'You can change everything by going to the app\'s settings, such as running in dark mode or light mode, and changing the app\'s language, such as English, Bengali, and Arabic.',
                // Modal specific
                addNewStudentTitle: 'Add New Student', updateStudentTitle: 'Update Student Info', studentNameLabel: 'Student Name', imageUrlLabel: 'Image URL', fatherNameLabel: 'Father\'s Name', motherNameLabel: 'Mother\'s Name', addressLabel: 'Address', departmentLabel: 'Department', rollLabel: 'Roll Number', monthlyFeeLabel: 'Monthly Fee', residenceTypeLabel: 'Residence Type', residenceResidential: 'Residential', residenceNonResidential: 'Non-Residential', residenceDayCare: 'Day Care', lillahBoardingLabel: 'Lillah Boarding', no: 'No', yes: 'Yes', saveBtn: 'Save',
                addNewDonationTitle: 'Add New Donation', updateDonationTitle: 'Update Donation Info', donorNameLabel: 'Donor Name', donationAmountLabel: 'Donation Amount', donationTypeLabel: 'Donation Type', donationTypePlaceholder: 'e.g., General, Zakat', receiverBookLabel: 'Receiver Book Name', receiptNoLabel: 'Receipt Number',
            },
            ar: {
                passwordLabel: '╪г╪п╪о┘Д ┘Г┘Д┘Е╪й ╪з┘Д┘Е╪▒┘И╪▒', loginButton: '╪к╪│╪м┘К┘Д ╪з┘Д╪п╪о┘И┘Д', loginError: '┘Г┘Д┘Е╪й ┘Е╪▒┘И╪▒ ╪о╪з╪╖╪ж╪й!',
                navDashboard: '┘Д┘И╪н╪й ╪з┘Д╪к╪н┘Г┘Е', navStudents: '╪е╪п╪з╪▒╪й ╪з┘Д╪╖┘Д╪з╪и', navFees: '╪з┘Д╪▒╪│┘И┘Е ╪з┘Д╪┤┘З╪▒┘К╪й', navExpenses: '┘Е╪╡╪з╪▒┘К┘Б ╪з┘Д╪│┘Г┘Ж', navDonations: '╪з┘Д╪к╪и╪▒╪╣╪з╪к / ╪з┘Д╪╡╪п┘В╪з╪к', navSettings: '╪з┘Д╪е╪╣╪п╪з╪п╪з╪к',
                dashboardTitle: '┘Д┘И╪н╪й ╪з┘Д╪к╪н┘Г┘Е', totalIncome: '╪е╪м┘Е╪з┘Д┘К ╪з┘Д╪п╪о┘Д', totalExpense: '╪е╪м┘Е╪з┘Д┘К ╪з┘Д┘Е╪╡╪▒┘И┘Б╪з╪к', cashBalance: '╪з┘Д╪▒╪╡┘К╪п ╪з┘Д┘Ж┘В╪п┘К ╪з┘Д╪н╪з┘Д┘К', monthlyIncome: '╪п╪о┘Д ┘З╪░╪з ╪з┘Д╪┤┘З╪▒', yearlyIncome: '╪п╪о┘Д ┘З╪░╪з ╪з┘Д╪╣╪з┘Е', totalStudents: '╪е╪м┘Е╪з┘Д┘К ╪з┘Д╪╖┘Д╪з╪и', lillahStudents: '╪╖┘Д╪з╪и ╪з┘Д╪│┘Г┘Ж',
                studentsTitle: '╪е╪п╪з╪▒╪й ╪з┘Д╪╖┘Д╪з╪и', addStudentBtn: '╪е╪╢╪з┘Б╪й ╪╖╪з┘Д╪и ╪м╪п┘К╪п', searchStudent: '╪и╪н╪л ╪╣┘Ж ╪╖╪з┘Д╪и', searchBySerial: '╪з┘Д╪и╪н╪л ╪и╪з┘Д╪▒┘В┘Е ╪з┘Д╪к╪│┘Д╪│┘Д┘К', enterSerialPlaceholder: '╪г╪п╪о┘Д ╪з┘Д╪▒┘В┘Е ╪з┘Д╪к╪│┘Д╪│┘Д┘К...',
                allStudents: '┘Г┘Д ╪з┘Д╪╖┘Д╪з╪и', thSerial: '╪з┘Д╪▒┘В┘Е', thImage: '╪з┘Д╪╡┘И╪▒╪й', thName: '╪з┘Д╪з╪│┘Е', thFatherName: '╪з╪│┘Е ╪з┘Д╪г╪и', thDepartment: '╪з┘Д┘В╪│┘Е', thRoll: '╪з┘Д┘Д┘Б╪й', thResidence: '╪з┘Д╪е┘В╪з┘Е╪й', thActions: '╪з┘Д╪е╪м╪▒╪з╪б╪з╪к', editBtn: '╪к╪╣╪п┘К┘Д', deleteBtn: '╪н╪░┘Б',
                noStudentFound: '┘Д┘Е ┘К╪к┘Е ╪з┘Д╪╣╪л┘И╪▒ ╪╣┘Д┘Й ╪╖┘Д╪з╪и.', studentNotFoundWithSerial: '┘Д┘Е ┘К╪к┘Е ╪з┘Д╪╣╪л┘И╪▒ ╪╣┘Д┘Й ╪╖╪з┘Д╪и ╪и┘З╪░╪з ╪з┘Д╪▒┘В┘Е.',
                feesTitle: '╪з┘Д╪▒╪│┘И┘Е ╪з┘Д╪┤┘З╪▒┘К╪й ┘Д┘Д╪╖╪з┘Д╪и', feeCollection: '╪к╪н╪╡┘К┘Д ╪з┘Д╪▒╪│┘И┘Е', selectMonth: '╪з╪о╪к╪▒ ╪з┘Д╪┤┘З╪▒', paidAmount: '╪з┘Д┘Е╪и┘Д╪║ ╪з┘Д┘Е╪п┘Б┘И╪╣', amountPlaceholder: '╪г╪п╪о┘Д ╪з┘Д┘Е╪и┘Д╪║', savePaymentBtn: '╪н┘Б╪╕ ╪з┘Д╪п┘Б╪╣', paymentHistory: '╪│╪м┘Д ╪з┘Д┘Е╪п┘Б┘И╪╣╪з╪к', noPaymentFound: '┘Д╪з ╪к┘И╪м╪п ┘Е╪п┘Б┘И╪╣╪з╪к.',
                expensesTitle: '┘Е╪╡╪з╪▒┘К┘Б ╪з┘Д╪│┘Г┘Ж', addExpense: '╪е╪╢╪з┘Б╪й ┘Е╪╡╪▒┘И┘Б ╪м╪п┘К╪п', date: '╪з┘Д╪к╪з╪▒┘К╪о', expenseAmount: '┘Е╪и┘Д╪║ ╪з┘Д┘Е╪╡╪▒┘И┘Б', description: '╪з┘Д┘И╪╡┘Б', descriptionPlaceholder: '┘И╪╡┘Б ╪з┘Д┘Е╪╡╪▒┘И┘Б', saveExpenseBtn: '╪н┘Б╪╕ ╪з┘Д┘Е╪╡╪▒┘И┘Б', expenseRecords: '╪│╪м┘Д╪з╪к ╪з┘Д┘Е╪╡╪з╪▒┘К┘Б', noExpenseFound: '┘Д╪з ╪к┘И╪м╪п ┘Е╪╡╪з╪▒┘К┘Б.',
                donationsTitle: '╪з┘Д╪к╪и╪▒╪╣╪з╪к / ╪з┘Д╪╡╪п┘В╪з╪к', addDonationBtn: '╪е╪╢╪з┘Б╪й ╪к╪и╪▒╪╣ ╪м╪п┘К╪п', allDonations: '╪м┘Е┘К╪╣ ╪з┘Д╪к╪и╪▒╪╣╪з╪к', thDonorName: '╪з╪│┘Е ╪з┘Д┘Е╪к╪и╪▒╪╣', thAmount: '╪з┘Д┘Е╪и┘Д╪║', thDonationType: '┘Ж┘И╪╣ ╪з┘Д╪к╪и╪▒╪╣', thReceiptNo: '╪▒┘В┘Е ╪з┘Д╪е┘К╪╡╪з┘Д', thDate: '╪з┘Д╪к╪з╪▒┘К╪о', noDonationFound: '┘Д╪з ╪к┘И╪м╪п ╪к╪и╪▒╪╣╪з╪к.',
                settingsTitle: '╪з┘Д╪е╪╣╪п╪з╪п╪з╪к', changePassword: '╪к╪║┘К┘К╪▒ ┘Г┘Д┘Е╪й ╪з┘Д┘Е╪▒┘И╪▒', currentPassword: '┘Г┘Д┘Е╪й ╪з┘Д┘Е╪▒┘И╪▒ ╪з┘Д╪н╪з┘Д┘К╪й', newPassword: '┘Г┘Д┘Е╪й ╪з┘Д┘Е╪▒┘И╪▒ ╪з┘Д╪м╪п┘К╪п╪й', changePasswordBtn: '╪к╪║┘К┘К╪▒ ┘Г┘Д┘Е╪й ╪з┘Д┘Е╪▒┘И╪▒', passwordSuccess: '╪к┘Е ╪к╪║┘К┘К╪▒ ┘Г┘Д┘Е╪й ╪з┘Д┘Е╪▒┘И╪▒ ╪и┘Ж╪м╪з╪н!', passwordError: '┘Г┘Д┘Е╪й ╪з┘Д┘Е╪▒┘И╪▒ ╪з┘Д╪н╪з┘Д┘К╪й ╪║┘К╪▒ ╪╡╪н┘К╪н╪й!',
                theme: '╪з┘Д┘Е╪╕┘З╪▒', selectTheme: '╪з╪о╪к╪▒ ┘Е╪╕┘З╪▒ ╪з┘Д╪к╪╖╪и┘К┘В', lightMode: '╪з┘Д┘И╪╢╪╣ ╪з┘Д┘Б╪з╪к╪н', darkMode: '╪з┘Д┘И╪╢╪╣ ╪з┘Д╪п╪з┘Г┘Ж',
                language: '╪з┘Д┘Д╪║╪й', selectLanguage: '╪з╪о╪к╪▒ ┘Д╪║╪й ╪з┘Д╪к╪╖╪и┘К┘В', settingsInfoText: '┘К┘Е┘Г┘Ж┘Г ╪к╪║┘К┘К╪▒ ┘Г┘Д ╪┤┘К╪б ╪и╪з┘Д╪░┘З╪з╪и ╪е┘Д┘Й ╪е╪╣╪п╪з╪п╪з╪к ╪з┘Д╪к╪╖╪и┘К┘В╪М ┘Е╪л┘Д ╪з┘Д╪к╪┤╪║┘К┘Д ┘Б┘К ╪з┘Д┘И╪╢╪╣ ╪з┘Д╪п╪з┘Г┘Ж ╪г┘И ╪з┘Д┘Б╪з╪к╪н╪М ┘И╪к╪║┘К┘К╪▒ ┘Д╪║╪й ╪з┘Д╪к╪╖╪и┘К┘В╪М ┘Е╪л┘Д ╪з┘Д╪е┘Ж╪м┘Д┘К╪▓┘К╪й ┘И╪з┘Д╪и┘Ж╪║╪з┘Д┘К╪й ┘И╪з┘Д╪╣╪▒╪и┘К╪й.',
                // Modal specific
                addNewStudentTitle: '╪е╪╢╪з┘Б╪й ╪╖╪з┘Д╪и ╪м╪п┘К╪п', updateStudentTitle: '╪к╪н╪п┘К╪л ╪и┘К╪з┘Ж╪з╪к ╪з┘Д╪╖╪з┘Д╪и', studentNameLabel: '╪з╪│┘Е ╪з┘Д╪╖╪з┘Д╪и', imageUrlLabel: '╪▒╪з╪и╪╖ ╪з┘Д╪╡┘И╪▒╪й', fatherNameLabel: '╪з╪│┘Е ╪з┘Д╪г╪и', motherNameLabel: '╪з╪│┘Е ╪з┘Д╪г┘Е', addressLabel: '╪з┘Д╪╣┘Ж┘И╪з┘Ж', departmentLabel: '╪з┘Д┘В╪│┘Е', rollLabel: '╪▒┘В┘Е ╪з┘Д┘Д┘Б╪й', monthlyFeeLabel: '╪з┘Д╪▒╪│┘И┘Е ╪з┘Д╪┤┘З╪▒┘К╪й', residenceTypeLabel: '┘Ж┘И╪╣ ╪з┘Д╪е┘В╪з┘Е╪й', residenceResidential: '╪│┘Г┘Ж┘К', residenceNonResidential: '╪║┘К╪▒ ╪│┘Г┘Ж┘К', residenceDayCare: '╪▒╪╣╪з┘К╪й ┘Ж┘З╪з╪▒┘К╪й', lillahBoardingLabel: '╪│┘Г┘Ж ┘Д┘Д┘З', no: '┘Д╪з', yes: '┘Ж╪╣┘Е', saveBtn: '╪н┘Б╪╕',
                addNewDonationTitle: '╪е╪╢╪з┘Б╪й ╪к╪и╪▒╪╣ ╪м╪п┘К╪п', updateDonationTitle: '╪к╪н╪п┘К╪л ╪и┘К╪з┘Ж╪з╪к ╪з┘Д╪к╪и╪▒╪╣', donorNameLabel: '╪з╪│┘Е ╪з┘Д┘Е╪к╪и╪▒╪╣', donationAmountLabel: '┘Е╪и┘Д╪║ ╪з┘Д╪к╪и╪▒╪╣', donationTypeLabel: '┘Ж┘И╪╣ ╪з┘Д╪к╪и╪▒╪╣', donationTypePlaceholder: '┘Е╪л╪з┘Д: ╪╣╪з┘Е╪М ╪▓┘Г╪з╪й', receiverBookLabel: '╪з╪│┘Е ╪п┘Б╪к╪▒ ╪з┘Д┘Е╪│╪к┘Д┘Е', receiptNoLabel: '╪▒┘В┘Е ╪з┘Д╪е┘К╪╡╪з┘Д',
            }
        };

        let currentLang = 'bn';

        // ===================================
        // DATABASE & STATE MANAGEMENT
        // ===================================
        const db = {
            getItem: (key) => localStorage.getItem(key),
            setItem: (key, value) => localStorage.setItem(key, value),
            getJSON: (key, defaultValue = []) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    return defaultValue;
                }
            },
            setJSON: (key, value) => {
                try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error(e); }
            }
        };

        let state = { students: [], donations: [], expenses: [], feePayments: {} };

        function loadInitialData() {
            state.students = db.getJSON('students', []);
            state.donations = db.getJSON('donations', []);
            state.expenses = db.getJSON('expenses', []);
            state.feePayments = db.getJSON('feePayments', {});
            recalculateStudentSerials();
        }

        function saveData() {
            db.setJSON('students', state.students);
            db.setJSON('donations', state.donations);
            db.setJSON('expenses', state.expenses);
            db.setJSON('feePayments', state.feePayments);
            updateDashboard();
        }
        
        // ===================================
        // INITIALIZATION & LOGIN
        // ===================================
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');

        function initialize() {
            if (!db.getItem('appPassword')) db.setItem('appPassword', '1357');
            if (sessionStorage.getItem('isLoggedIn') === 'true') showApp();
            
            const savedTheme = db.getItem('theme') || 'light';
            const savedLang = db.getItem('language') || 'bn';
            
            applyTheme(savedTheme, false);
            applyLanguage(savedLang, false);
            
            loadInitialData();
            renderAll();
            setupEventListeners();
        }

        function showApp() {
            loginScreen.classList.add('hidden');
            appContainer.style.visibility = 'visible';
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('password').value === db.getItem('appPassword')) {
                sessionStorage.setItem('isLoggedIn', 'true');
                showApp();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        });

        // ===================================
        // SPA NAVIGATION
        // ===================================
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.app-section');

        navLinks.forEach(link => link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = e.currentTarget.getAttribute('href').substring(1);
            sections.forEach(s => s.classList.toggle('active', s.id === targetId));
            navLinks.forEach(l => l.classList.toggle('active', l.getAttribute('href') === `#${targetId}`));
        }));


        // ===================================
        // DASHBOARD
        // ===================================
        function updateDashboard() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const totalFeeIncome = Object.values(state.feePayments).flat().reduce((sum, p) => sum + p.amount, 0);
            const totalDonationIncome = state.donations.reduce((sum, d) => sum + d.amount, 0);
            const totalIncome = totalFeeIncome + totalDonationIncome;
            
            const monthlyFeeIncome = Object.values(state.feePayments).flat().filter(p => new Date(p.date).getMonth() === currentMonth && new Date(p.date).getFullYear() === currentYear).reduce((sum, p) => sum + p.amount, 0);
            const monthlyDonationIncome = state.donations.filter(d => new Date(d.date).getMonth() === currentMonth && new Date(d.date).getFullYear() === currentYear).reduce((sum, d) => sum + d.amount, 0);
            const monthlyIncome = monthlyFeeIncome + monthlyDonationIncome;
            
            const yearlyFeeIncome = Object.values(state.feePayments).flat().filter(p => new Date(p.date).getFullYear() === currentYear).reduce((sum, p) => sum + p.amount, 0);
            const yearlyDonationIncome = state.donations.filter(d => new Date(d.date).getFullYear() === currentYear).reduce((sum, d) => sum + d.amount, 0);
            const yearlyIncome = yearlyFeeIncome + yearlyDonationIncome;

            const totalExpense = state.expenses.reduce((sum, e) => sum + e.amount, 0);
            const cashBalance = totalIncome - totalExpense; // NEW CALCULATION

            // Update UI
            const formatCurrency = (val) => `рз│${val.toLocaleString('en-IN')}`;
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
            document.getElementById('cash-balance').textContent = formatCurrency(cashBalance); // UPDATE UI
            document.getElementById('monthly-income').textContent = formatCurrency(monthlyIncome);
            document.getElementById('yearly-income').textContent = formatCurrency(yearlyIncome);
            document.getElementById('total-students').textContent = state.students.length;
            document.getElementById('lillah-students').textContent = state.students.filter(s => s.lillahBoarding === 'Yes').length;
        }

        // ===================================
        // STUDENTS MANAGEMENT
        // ===================================
        const studentModal = document.getElementById('student-modal');
        const studentForm = document.getElementById('student-form');
        const studentsTableBody = document.querySelector('#students-table tbody');
        const DEFAULT_IMAGE = 'https://i.ibb.co/7j1j6bM/default-avatar.png';

        function recalculateStudentSerials() { state.students.forEach((s, i) => s.serial = i + 1); }

        function renderStudents() {
            studentsTableBody.innerHTML = '';
            if (state.students.length === 0) {
                studentsTableBody.innerHTML = `<tr><td colspan="8" class="text-center" data-translate-key="noStudentFound">${translations[currentLang].noStudentFound}</td></tr>`;
                return;
            }
            state.students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.serial}</td>
                    <td><img src="${student.imageUrl || DEFAULT_IMAGE}" class="student-image-sm" onerror="this.onerror=null;this.src='${DEFAULT_IMAGE}'"></td>
                    <td>${student.name}</td>
                    <td>${student.fatherName}</td>
                    <td>${student.department}</td>
                    <td>${student.roll}</td>
                    <td>${student.residenceType}</td>
                    <td class="action-buttons">
                        <button class="btn btn-secondary" onclick="editStudent(${student.serial})">${translations[currentLang].editBtn}</button>
                        <button class="btn btn-danger" onclick="deleteStudent(${student.serial})">${translations[currentLang].deleteBtn}</button>
                    </td>
                `;
                studentsTableBody.appendChild(row);
            });
        }

        function openStudentModal(mode, studentData = null) {
            studentForm.reset();
            document.getElementById('student-id').value = '';
            const modalTitle = document.getElementById('student-modal-title');
            
            if (mode === 'add') {
                modalTitle.textContent = translations[currentLang].addNewStudentTitle;
            } else if (mode === 'edit' && studentData) {
                modalTitle.textContent = translations[currentLang].updateStudentTitle;
                Object.keys(studentData).forEach(key => {
                    const element = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`));
                    if (element) element.value = studentData[key];
                });
                document.getElementById('student-id').value = studentData.serial;
                document.getElementById('student-image-url').value = studentData.imageUrl;
            }
            studentModal.style.display = 'flex';
        }

        studentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const studentId = document.getElementById('student-id').value;
            const studentData = {
                name: document.getElementById('student-name').value, imageUrl: document.getElementById('student-image-url').value, fatherName: document.getElementById('father-name').value, motherName: document.getElementById('mother-name').value, address: document.getElementById('address').value,
                department: document.getElementById('department').value, roll: parseInt(document.getElementById('roll').value), monthlyFee: parseFloat(document.getElementById('monthly-fee').value), residenceType: document.getElementById('residence-type').value, lillahBoarding: document.getElementById('lillah-boarding').value,
            };

            if (studentId) {
                const index = state.students.findIndex(s => s.serial == studentId);
                if (index !== -1) state.students[index] = { ...state.students[index], ...studentData };
            } else {
                studentData.serial = state.students.length > 0 ? Math.max(...state.students.map(s => s.serial)) + 1 : 1;
                state.students.push(studentData);
            }
            recalculateStudentSerials(); saveData(); renderStudents(); studentModal.style.display = 'none';
        });

        window.editStudent = (serial) => openStudentModal('edit', state.students.find(s => s.serial === serial));
        window.deleteStudent = (serial) => {
            if (confirm(`Are you sure you want to delete student #${serial}?`)) {
                state.students = state.students.filter(s => s.serial !== serial);
                recalculateStudentSerials(); saveData(); renderStudents();
            }
        };
        
        // Student Search
        const searchStudentInput = document.getElementById('search-student-serial');
        const searchResultDiv = document.getElementById('student-search-result');
        searchStudentInput.addEventListener('input', (e) => {
            const serial = parseInt(e.target.value);
            searchResultDiv.innerHTML = '';
            if (!serial) return;
            
            const student = state.students.find(s => s.serial === serial);
            if (student) {
                searchResultDiv.innerHTML = `
                    <div class="card mt-2 student-search-card">
                        <img src="${student.imageUrl || DEFAULT_IMAGE}" class="student-image-lg" onerror="this.onerror=null;this.src='${DEFAULT_IMAGE}'">
                        <div>
                            <h4>${student.name} (Serial: ${student.serial})</h4>
                            <p><strong>${translations[currentLang].fatherNameLabel}:</strong> ${student.fatherName}</p>
                            <p><strong>${translations[currentLang].departmentLabel}:</strong> ${student.department}, <strong>${translations[currentLang].rollLabel}:</strong> ${student.roll}</p>
                            <p><strong>${translations[currentLang].monthlyFeeLabel}:</strong> рз│${student.monthlyFee}</p>
                        </div>
                    </div>
                `;
            } else {
                searchResultDiv.innerHTML = `<p class="mt-2" data-translate-key="studentNotFoundWithSerial">${translations[currentLang].studentNotFoundWithSerial}</p>`;
            }
        });


        // ===================================
        // STUDENT MONTHLY FEE (NO DUE)
        // ===================================
        const feeStudentSearch = document.getElementById('fee-student-search');
        let currentFeeStudentSerial = null;

        feeStudentSearch.addEventListener('input', (e) => {
            const serial = parseInt(e.target.value);
            currentFeeStudentSerial = null;
            document.getElementById('fee-student-info').style.display = 'none';
            document.getElementById('fee-payment-history').innerHTML = '';
            if (!serial) return;

            const student = state.students.find(s => s.serial === serial);
            if (student) {
                currentFeeStudentSerial = student.serial;
                document.getElementById('fee-student-name').textContent = `${translations[currentLang].studentNameLabel}: ${student.name}`;
                document.getElementById('fee-father-name').textContent = student.fatherName;
                document.getElementById('fee-monthly-amount').textContent = `рз│${student.monthlyFee}`;
                document.getElementById('fee-student-info').style.display = 'block';
                document.getElementById('fee-month').valueAsDate = new Date();
                renderFeeHistory(student.serial);
            }
        });

        function renderFeeHistory(serial) {
            const historyDiv = document.getElementById('fee-payment-history');
            const payments = state.feePayments[serial] || [];
            
            historyDiv.innerHTML = `<h4 data-translate-key="paymentHistory">${translations[currentLang].paymentHistory}</h4>`;
            if (payments.length === 0) {
                historyDiv.innerHTML += `<p data-translate-key="noPaymentFound">${translations[currentLang].noPaymentFound}</p>`;
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-100 mt-1';
            table.innerHTML = `
                <thead><tr><th>${translations[currentLang].selectMonth}</th><th>${translations[currentLang].thAmount}</th><th>${translations[currentLang].thDate}</th></tr></thead>
                <tbody>
                    ${payments.map(p => `<tr><td>${p.month}</td><td>рз│${p.amount}</td><td>${new Date(p.date).toLocaleDateString('bn-BD')}</td></tr>`).join('')}
                </tbody>`;
            historyDiv.appendChild(table);
        }

        document.getElementById('save-fee-payment').addEventListener('click', () => {
            if (!currentFeeStudentSerial) return;
            const month = document.getElementById('fee-month').value;
            const amount = parseFloat(document.getElementById('fee-paid-amount').value);
            if (!month || isNaN(amount) || amount <= 0) return alert('Please enter a valid month and amount.');

            if (!state.feePayments[currentFeeStudentSerial]) state.feePayments[currentFeeStudentSerial] = [];
            state.feePayments[currentFeeStudentSerial].push({ month, amount, date: new Date().toISOString() });

            saveData();
            renderFeeHistory(currentFeeStudentSerial);
            document.getElementById('fee-paid-amount').value = '';
            alert('Payment saved successfully!');
        });

        // ===================================
        // EXPENSES & DONATIONS
        // (Logic is largely unchanged, just need translation on render)
        // ===================================
        const expensesTableBody = document.querySelector('#expenses-table tbody');
        const donationsTableBody = document.querySelector('#donations-table tbody');

        function renderExpenses() {
            expensesTableBody.innerHTML = '';
            if (state.expenses.length === 0) {
                expensesTableBody.innerHTML = `<tr><td colspan="4" class="text-center">${translations[currentLang].noExpenseFound}</td></tr>`; return;
            }
            [...state.expenses].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                expensesTableBody.innerHTML += `<tr><td>${new Date(expense.date).toLocaleDateString('bn-BD')}</td><td>${expense.description}</td><td>рз│${expense.amount}</td>
                    <td class="action-buttons"><button class="btn btn-danger" onclick="deleteExpense('${expense.id}')">${translations[currentLang].deleteBtn}</button></td></tr>`;
            });
        }
        document.getElementById('expense-form').addEventListener('submit', e => {
            e.preventDefault();
            state.expenses.push({ id: `exp_${Date.now()}`, date: document.getElementById('expense-date').value, amount: parseFloat(document.getElementById('expense-amount').value), description: document.getElementById('expense-description').value });
            saveData(); renderExpenses(); e.target.reset();
        });
        window.deleteExpense = (id) => { if (confirm('Delete this expense?')) { state.expenses = state.expenses.filter(e => e.id !== id); saveData(); renderExpenses(); }};

        function renderDonations() {
            donationsTableBody.innerHTML = '';
            if (state.donations.length === 0) {
                donationsTableBody.innerHTML = `<tr><td colspan="6" class="text-center">${translations[currentLang].noDonationFound}</td></tr>`; return;
            }
            [...state.donations].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(d => {
                donationsTableBody.innerHTML += `<tr><td>${new Date(d.date).toLocaleDateString('bn-BD')}</td><td>${d.donorName}</td><td>рз│${d.amount}</td><td>${d.type}</td><td>${d.receiptNumber}</td>
                    <td class="action-buttons"><button class="btn btn-secondary" onclick="editDonation('${d.id}')">${translations[currentLang].editBtn}</button><button class="btn btn-danger" onclick="deleteDonation('${d.id}')">${translations[currentLang].deleteBtn}</button></td></tr>`;
            });
        }
        document.getElementById('donation-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('donation-id').value;
            const data = { donorName: document.getElementById('donor-name').value, amount: parseFloat(document.getElementById('donation-amount').value), type: document.getElementById('donation-type').value, receiverBook: document.getElementById('receiver-book').value, receiptNumber: document.getElementById('receipt-number').value };
            if (id) {
                const index = state.donations.findIndex(d => d.id === id);
                if (index !== -1) state.donations[index] = { ...state.donations[index], ...data };
            } else {
                state.donations.push({ ...data, id: `don_${Date.now()}`, date: new Date().toISOString() });
            }
            saveData(); renderDonations(); document.getElementById('donation-modal').style.display = 'none';
        });
        const openDonationModal = (mode, data = null) => {
            document.getElementById('donation-form').reset(); document.getElementById('donation-id').value = '';
            document.getElementById('donation-modal-title').textContent = mode === 'add' ? translations[currentLang].addNewDonationTitle : translations[currentLang].updateDonationTitle;
            if (mode === 'edit' && data) {
                Object.keys(data).forEach(key => { const el = document.getElementById(key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`)); if (el) el.value = data[key]; });
                document.getElementById('donation-id').value = data.id;
            }
            document.getElementById('donation-modal').style.display = 'flex';
        }
        window.editDonation = (id) => openDonationModal('edit', state.donations.find(d => d.id === id));
        window.deleteDonation = (id) => { if (confirm('Delete this donation?')) { state.donations = state.donations.filter(d => d.id !== id); saveData(); renderDonations(); }};

        // ===================================
        // SETTINGS & LANGUAGE
        // ===================================
        function translateUI(lang) {
            const elements = document.querySelectorAll('[data-translate-key]');
            elements.forEach(el => {
                const key = el.dataset.translateKey;
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            const placeholders = document.querySelectorAll('[data-translate-key-placeholder]');
            placeholders.forEach(el => {
                const key = el.dataset.translateKeyPlaceholder;
                 if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
        }

        function applyLanguage(lang, rerender = true) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.body.classList.toggle('rtl', lang === 'ar');
            document.getElementById('language-selector').value = lang;
            db.setItem('language', lang);
            translateUI(lang);
            if (rerender) renderAll(); // Rerender tables to update button texts etc.
        }
        
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('theme-selector').value = theme;
            db.setItem('theme', theme);
        }
        
        document.getElementById('change-password-form').addEventListener('submit', e => {
            e.preventDefault();
            const current = document.getElementById('current-password').value, newP = document.getElementById('new-password').value, status = document.getElementById('password-change-status');
            if (current === db.getItem('appPassword')) {
                db.setItem('appPassword', newP);
                status.textContent = translations[currentLang].passwordSuccess; status.style.color = 'var(--success-color)';
            } else {
                status.textContent = translations[currentLang].passwordError; status.style.color = 'var(--error-color)';
            }
        });

        // ===================================
        // EVENT LISTENERS & INITIALIZATION
        // ===================================
        function setupEventListeners() {
            document.getElementById('add-student-btn').addEventListener('click', () => openStudentModal('add'));
            document.getElementById('add-donation-btn').addEventListener('click', () => openDonationModal('add'));
            document.getElementById('theme-selector').addEventListener('change', (e) => applyTheme(e.target.value));
            document.getElementById('language-selector').addEventListener('change', (e) => applyLanguage(e.target.value));
            document.querySelectorAll('.modal').forEach(modal => {
                modal.querySelector('.close-button').onclick = () => modal.style.display = 'none';
                window.onclick = (e) => { if (e.target == modal) modal.style.display = 'none'; };
            });
        }
        
        function renderAll() {
            renderStudents();
            renderDonations();
            renderExpenses();
            updateDashboard();
        }

        initialize();
    };
    </script>
</body>
</html>
